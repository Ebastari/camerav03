<!doctype html>
<html lang="id">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no, viewport-fit=cover" />
<title>PT Energi Batubara Lestari - Monitoring</title>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.css" crossorigin="anonymous"/>
<script src="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.js" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/piexifjs@1.0.6/dist/piexif.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/dexie@4.0.1/dist/dexie.min.js"></script>

<style>
  :root {
    --bg:#0b0f1a; --surface:#111827; --muted:#6b7280; --text:#e5e7eb;
    /* Warna aksen yang lebih menarik */
    --accent:#10b981; --accent-hover:#059669; --accent-light:rgba(16,185,129,0.15);
    --danger:#ef4444; --danger-hover:#dc2626;
    --warn:#f59e0b; --warn-hover:#d97706;
    --primary:#3b82f6; --primary-hover:#2563eb;
    --green-bg: rgba(16, 43, 33, 0.85);
    --green-border: rgba(16, 185, 129, 0.5);
    --card-bg: rgba(17, 24, 39, 0.85);
    --card-border: rgba(255, 255, 255, 0.1);
    --shadow-lg: 0 10px 40px rgba(0, 0, 0, 0.4);
    --shadow-sm: 0 2px 8px rgba(0, 0, 0, 0.2);
  }
  
  html,body{
    height:100%;
    margin:0;
    background:#000;
    color:var(--text);
    font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif;
    overflow:hidden
  }
  
  .app{
    position:fixed;
    inset:0;
    display:flex;
    flex-direction:column
  }
  
  /* Camera layer dengan overlay gradient */
  .camera-wrap{
    position:relative;
    flex:1;
    background:#000;
    display:flex;
    align-items:center;
    justify-content:center
  }
  video{
    position:absolute;
    inset:0;
    width:100%;
    height:100%;
    object-fit:cover
  }
  canvas#canvas{display:none}
  
  /* Camera overlay vignette effect */
  .camera-wrap::after {
    content: '';
    position: absolute;
    inset: 0;
    background: radial-gradient(ellipse at center, transparent 40%, rgba(0,0,0,0.3) 80%, rgba(0,0,0,0.6) 100%);
    pointer-events: none;
    z-index: 1;
  }

  /* Pin di tengah layar dengan animasi pulse */
  .map-pin {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -100%);
    font-size: 40px;
    z-index: 10;
    color: rgba(239, 68, 68, 0.7);
    text-shadow: 0 2px 6px rgba(0,0,0,0.5);
    pointer-events: none;
    animation: pinPulse 3s ease-in-out infinite;
    opacity: 0.8;
  }

  @keyframes pinPulse {
    0%, 100% { transform: translate(-50%, -100%) scale(1); }
    50% { transform: translate(-50%, -100%) scale(1.1); }
  }

  /* Toolbar Bawah dengan floating effect */
  .toolbar{
    position:absolute;
    bottom:28px;
    left:0;
    right:0;
    display:flex;
    justify-content:center;
    gap:16px;
    z-index:20;
    align-items:center;
    padding: 0 20px;
  }
  
  .fab {
    width:72px;
    height:72px;
    border-radius:50%;
    border:4px solid rgba(255,255,255,0.95);
    display:flex;
    align-items:center;
    justify-content:center;
    cursor:pointer;
    background: linear-gradient(135deg, #fff 0%, #f0f0f0 100%);
    box-shadow: 0 4px 20px rgba(0,0,0,0.4), 0 0 0 2px rgba(255,255,255,0.1);
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  }
  
  .fab::after{
    content:"";
    width:56px;
    height:56px;
    background:#fff;
    border-radius:50%;
    transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
  }
  
  .fab:hover {
    transform: scale(1.05);
    box-shadow: 0 6px 30px rgba(0,0,0,0.5), 0 0 0 4px rgba(16,185,129,0.3);
  }
  
  .fab:active {
    transform: scale(0.95);
  }
  
  .fab:active::after{
    transform: scale(0.85);
    background: var(--accent);
  }
  
  .btn{
    background:rgba(255,255,255,0.12);
    border:1px solid rgba(255,255,255,0.25);
    backdrop-filter:blur(10px);
    -webkit-backdrop-filter:blur(10px);
    color:#fff;
    border-radius:16px;
    padding:12px 18px;
    cursor:pointer;
    font-weight:500;
    font-size:14px;
    transition: all 0.2s ease;
    box-shadow: var(--shadow-sm);
  }
  
  .btn:hover {
    background:rgba(255,255,255,0.2);
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.3);
  }
  
  .btn:active {
    transform: translateY(0);
  }
  
  .btn.round{
    width:56px;
    height:56px;
    border-radius:50%;
    display:flex;
    align-items:center;
    justify-content:center;
    font-size:24px;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  }
  
  .btn.round:hover {
    background:rgba(255,255,255,0.25);
    transform: scale(1.1);
  }
  
  .btn.round:active {
    transform: scale(0.9);
    background:rgba(255,255,255,0.3);
  }
  
  /* Style untuk thumbnail */
  #btnLastPhoto {
    padding: 0;
    width: 56px;
    height: 56px;
    border-radius: 50%;
    overflow: hidden;
    border: 3px solid rgba(255,255,255,0.9);
    background: #1f2937;
    box-shadow: 0 2px 10px rgba(0,0,0,0.3);
    transition: all 0.3s ease;
  }
  
  #btnLastPhoto:hover {
    border-color: var(--accent);
    box-shadow: 0 0 20px rgba(16,185,129,0.4);
  }
  
  #lastPhotoThumb {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  /* Header dengan gradient */
  .header {
    position: absolute;
    top: 12px;
    left: 0;
    right: 0;
    text-align: center;
    font-size: 14px;
    font-weight: 600;
    color: rgba(255,255,255,0.85);
    text-shadow: 0 2px 8px rgba(0,0,0,0.6);
    z-index: 21;
    pointer-events: none;
    letter-spacing: 0.5px;
  }
  
  /* Top chips (di bawah header) dengan improved styling */
  .topbar{
    position:absolute;
    top: 50px;
    left:16px;
    right:16px;
    display:flex;
    justify-content:space-between;
    gap:12px;
    z-index:20;
    flex-wrap:wrap;
  }
  
  .chip{
    background:rgba(0,0,0,0.35);
    border:1px solid rgba(255,255,255,0.1);
    border-radius:10px;
    padding:8px 12px;
    font-size:12px;
    margin-top:4px;
    transition: all 0.3s ease;
    backdrop-filter:blur(8px);
    -webkit-backdrop-filter:blur(8px);
  }
  
  .chip:hover {
    background:rgba(0,0,0,0.5);
    border-color: rgba(255,255,255,0.2);
  }
  
  /* Style GPS Aktif */
  #chipGPS {
    display: flex;
    align-items: center;
    gap: 6px;
    min-width: 90px;
  }
  
  #chipGPS .dot {
    width: 10px;
    height: 10px;
    border-radius: 50%;
    background-color: var(--muted);
    transition: all 0.3s ease;
  }
  
  #chipGPS.gps-good .dot { 
    background-color: var(--accent);
  }
  #chipGPS.gps-medium .dot { 
    background-color: var(--warn);
  }
  #chipGPS.gps-bad .dot { 
    background-color: var(--danger);
  }
  
  /* Style Target Progress Bar */
  .chip#chipGoal {
    min-width: 120px;
    padding: 8px 12px;
    display: flex;
    flex-direction: column;
    gap: 4px;
  }
  
  #chipGoalText { 
    font-size: 11px;
    font-weight: 600;
  }
  
  .goal-bar {
    width: 100%;
    height: 4px;
    background: rgba(255,255,255,0.1);
    border-radius: 99px;
    overflow: hidden;
  }
  
  #goalBarFill {
    display: block;
    height: 100%;
    width: 0%;
    background: var(--accent);
    border-radius: 99px;
    transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1);
  }

  /* Overlay info box */
  .overlay{
    position:absolute;
    left:16px;
    right:16px;
    bottom: 300px;
    z-index:15;
    background: rgba(0,0,0,0.25);
    border: 1px solid rgba(255,255,255,0.1);
    backdrop-filter:blur(8px);
    -webkit-backdrop-filter:blur(8px);
    padding:12px 14px;
    border-radius:12px;
    min-width:240px;
    cursor: default;
    box-shadow: none;
    transition: all 0.3s ease;
  }
  
  .overlay:hover {
    transform: none;
    box-shadow: none;
  }
  
  .overlay h4{
    margin:0 0 8px 0;
    font-size:14px; 
    font-weight: 700; 
    color: rgba(255,255,255,0.9);
    display: flex;
    align-items: center;
    gap: 6px;
  }
  
  .overlay h4::before {
    content: '';
    width: 3px;
    height: 14px;
    background: rgba(16,185,129,0.8);
    border-radius: 2px;
  }
  
  .overlay .row{
    font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas,"Liberation Mono","Courier New",monospace;
    font-size:12px;
    line-height:1.6; 
    color: rgba(255,255,255,0.8);
    display: flex;
    justify-content: space-between;
    padding: 2px 0;
    border-bottom: none;
  }
  
  .overlay .row:last-child {
    border-bottom: none;
  }
  
  .overlay .row .label { 
    color: rgba(255,255,255,0.5); 
    font-weight: 500;
  }
  
  .overlay .row .value { 
    color: rgba(255,255,255,0.95); 
    font-weight: 600;
  }

  /* Slider tinggi */
  .height-wrap{
    position:absolute;
    left:0;
    right:0;
    bottom: 160px;
    display:flex;
    justify-content:center;
    z-index:14
  }
  
  .height-panel{
    width:min(540px,92%);
    background: rgba(0,0,0,0.25);
    border: 1px solid rgba(255,255,255,0.1);
    border-radius:14px;
    padding:12px 16px;
    backdrop-filter:blur(8px);
    -webkit-backdrop-filter:blur(8px);
    box-shadow: none;
    transition: all 0.3s ease;
  }
  
  .height-panel:hover {
    transform: none;
    box-shadow: none;
  }
  
  #tinggiRange{
    width:100%;
    height: 6px;
    -webkit-appearance: none;
    appearance: none;
    background: rgba(255,255,255,0.15);
    border-radius: 99px;
    outline: none;
    margin-top: 10px;
    cursor: pointer;
  }
  
  #tinggiRange::-webkit-slider-thumb {
    -webkit-appearance: none;
    appearance: none;
    width: 20px;
    height: 20px;
    border-radius: 50%;
    background: var(--accent);
    cursor: pointer;
    box-shadow: 0 2px 8px rgba(16,185,129,0.4);
    transition: all 0.2s ease;
  }
  
  #tinggiRange::-webkit-slider-thumb:hover {
    transform: scale(1.1);
    box-shadow: 0 4px 12px rgba(16,185,129,0.5);
  }
  
  #tinggiRange::-moz-range-thumb {
    width: 20px;
    height: 20px;
    border-radius: 50%;
    background: var(--accent);
    cursor: pointer;
    border: none;
    box-shadow: 0 2px 8px rgba(16,185,129,0.4);
  }
  
  .height-panel .value{
    font-weight:700;
    font-size: 18px;
    color: var(--accent);
  }

  /* Quick options */
  .quick{
    position:absolute;
    left:0;
    right:0;
    bottom: 230px;
    display:flex;
    gap:8px;
    justify-content:center;
    z-index:13;
    pointer-events:none;
    padding: 0 16px;
    overflow-x: auto;
    justify-content: flex-start;
  }
  
  /* Custom scrollbar */
  .quick::-webkit-scrollbar { 
    height: 3px; 
  }
  
  .quick::-webkit-scrollbar-track { 
    background: transparent;
  }
  
  .quick::-webkit-scrollbar-thumb { 
    background: rgba(16,185,129,0.4);
    border-radius: 99px;
  }
  
  .quick { -ms-overflow-style: none; scrollbar-width: thin; scrollbar-color: rgba(16,185,129,0.4) transparent; }
  
  .quick .tag{
    pointer-events:auto;
    padding:8px 14px;
    border-radius: 8px;
    border: 1px solid rgba(255,255,255,0.15);
    background: rgba(0,0,0,0.25);
    user-select:none;
    cursor:pointer;
    font-size: 13px;
    font-weight: 500;
    flex-shrink: 0;
    transition: all 0.2s ease;
    backdrop-filter:blur(6px);
    -webkit-backdrop-filter:blur(6px);
  }
  
  .quick .tag:hover {
    background: rgba(0,0,0,0.4);
    transform: none;
    border-color: rgba(255,255,255,0.25);
  }
  
  .tag.on{
    background: rgba(16,185,129,0.7);
    color:#fff;
    border-color: transparent;
    font-weight:600;
    box-shadow: none;
    transform: none;
  }
  
  .tag.on:hover {
    transform: none;
    background: rgba(16,185,129,0.85);
  }

  /* Bottom Sheet dengan improved styling */
  .sheet{
    position:fixed;
    left:0;
    right:0;
    bottom:0;
    height:85vh;
    background: linear-gradient(180deg, var(--surface) 0%, #0f172a 100%);
    border-top-left-radius:24px;
    border-top-right-radius:24px;
    box-shadow: 0 -10px 40px rgba(0,0,0,0.5);
    transform:translateY(100%);
    transition:transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    z-index:30;
    display:flex;
    flex-direction:column
  }
  
  .sheet.visible{
    transform:translateY(0)
  }
  
  .handle{
    padding:12px;
    text-align:center;
    border-bottom:1px solid rgba(255,255,255,0.08);
    cursor:pointer;
    transition: background-color 0.2s ease;
  }
  
  .handle:hover {
    background: rgba(255,255,255,0.02);
  }
  
  .handle .bar{
    width:50px;
    height:6px;
    margin:0 auto;
    border-radius:3px;
    background: rgba(255,255,255,0.3);
    transition: all 0.2s ease;
  }
  
  .handle:hover .bar {
    background: var(--accent);
    width: 60px;
  }
  
  .sheet-content{
    flex:1;
    overflow:auto;
    padding:20px;
    display:grid;
    grid-template-columns:1fr;
    gap:20px
  }
  
  .sheet-content::-webkit-scrollbar {
    width: 6px;
  }
  
  .sheet-content::-webkit-scrollbar-track {
    background: transparent;
  }
  
  .sheet-content::-webkit-scrollbar-thumb {
    background: rgba(255,255,255,0.15);
    border-radius: 3px;
  }
  
  .sheet-content::-webkit-scrollbar-thumb:hover {
    background: rgba(16,185,129,0.5);
  }

  /* Cards dengan improved styling */
  .card{
    background: var(--card-bg);
    border: 1px solid var(--card-border);
    border-radius:16px;
    padding:18px;
    transition: all 0.3s ease;
    box-shadow: var(--shadow-sm);
  }
  
  .card:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 30px rgba(0,0,0,0.4);
    border-color: rgba(16,185,129,0.3);
  }
  
  .card h3{
    margin:0 0 14px 0;
    font-size:17px;
    font-weight:700;
    color: #fff;
    display: flex;
    align-items: center;
    gap: 8px;
  }
  
  .card h3::before {
    content: '';
    width: 4px;
    height: 18px;
    background: linear-gradient(180deg, var(--accent), #059669);
    border-radius: 2px;
  }
  
  .grid-2{
    display:grid;
    grid-template-columns:1fr;
    gap:16px
  }
  
  @media(min-width:860px){
    .grid-2{
      grid-template-columns:1.2fr 1fr
    }
    .row-flex{
      grid-template-columns:1fr 1fr
    }
  }
  
  #map{
    width:100%;
    height:340px;
    border-radius:14px;
    border: 1px solid var(--card-border);
    transition: all 0.3s ease;
  }
  
  #map:hover {
    border-color: rgba(16,185,129,0.4);
    box-shadow: 0 0 20px rgba(16,185,129,0.15);
  }

  /* Toast dengan improved styling */
  .toast{
    position:fixed;
    right:20px;
    bottom:100px;
    background: var(--card-bg);
    color:#e5e7eb;
    border: 1px solid var(--card-border);
    border-radius:14px;
    padding:14px 18px;
    z-index:60;
    opacity:0;
    transform:translateY(16px) scale(0.95);
    transition:all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    box-shadow: var(--shadow-lg);
    max-width: 320px;
  }
  
  .toast.show{
    opacity:1;
    transform:translateY(0) scale(1)
  }
  
  .toast.success {
    border-left: 4px solid var(--accent);
  }
  
  .toast.error {
    border-left: 4px solid var(--danger);
  }
  
  .toast.warning {
    border-left: 4px solid var(--warn);
  }
  
  .progress{
    height:5px;
    background:rgba(255,255,255,0.1);
    border-radius:99px;
    overflow:hidden;
    margin-top:10px;
  }
  
  .progress>i{
    display:block;
    height:100%;
    width:0;
    background: linear-gradient(90deg, var(--accent), #34d399);
    border-radius:99px;
    transition: width 0.3s ease;
  }
  
  .hr{
    height:1px;
    background:rgba(255,255,255,0.08);
    margin:14px 0;
  }
  
  .muted{
    color:#9ca3af;
    font-size:14px;
  }
  
  /* Input fields dengan improved styling */
  input[type="number"],input[type="text"], select {
    width:100%;
    background: rgba(0,0,0,0.3);
    border: 1px solid var(--card-border);
    border-radius:12px;
    padding:12px 14px;
    color:#e5e7eb;
    box-sizing: border-box;
    font-size:14px;
    transition: all 0.2s ease;
  }
  
  input[type="number"]:focus, input[type="text"]:focus, select:focus {
    outline: none;
    border-color: var(--accent);
    box-shadow: 0 0 0 3px rgba(16,185,129,0.2);
    background: rgba(0,0,0,0.4);
  }
  
  input[type="number"]::placeholder, input[type="text"]::placeholder {
    color: rgba(255,255,255,0.3);
  }
  
  label{
    font-size:12px;
    color:#9ca3af;
    font-weight: 500;
    margin-bottom: 6px;
    display: block;
  }
  
  .row-flex{
    display:grid;
    grid-template-columns:1fr;
    gap:14px
  }
  
  @media(min-width:500px){
    .row-flex{
      grid-template-columns:1fr 1fr
    }
  }
  
  /* Download links dengan improved styling */
  .download-links a{
    display:block;
    padding:14px 16px;
    border: 1px solid var(--card-border);
    border-radius:12px;
    text-decoration:none;
    color:#e5e7eb;
    background: rgba(255,255,255,0.05);
    text-align:center;
    font-weight: 500;
    transition: all 0.2s ease;
  }
  
  .download-links a:hover {
    background: rgba(16,185,129,0.15);
    border-color: var(--accent);
    color: var(--accent);
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.2);
  }

  /* GPS Status styling */
  .gps-good { 
    background-color: var(--accent) !important; 
    color: #fff !important; 
  }
  .gps-medium { 
    background-color: var(--warn) !important; 
    color: #000 !important; 
  }
  .gps-bad { 
    background-color: var(--danger) !important; 
    color: #fff !important; 
  }
  
  .btn.round.gps-sampling {
    font-size: 14px;
    font-weight: bold;
    color: #000;
    background-color: var(--warn);
    animation: pulse 1.5s ease-in-out infinite;
  }
  
  @keyframes pulse {
    0%, 100% { opacity: 1; box-shadow: 0 0 0 0 rgba(245,158,11,0.4); }
    50% { opacity: 0.8; box-shadow: 0 0 0 10px rgba(245,158,11,0); }
  }
  
  #ccResult .row { 
    font-family: ui-monospace, monospace; 
    line-height: 1.8; 
    font-size: 14px;
    padding: 6px 0;
  }
  
  .progress-bar-container {
    width: 100%;
    height: 10px;
    background-color: rgba(255,255,255,0.1);
    border-radius: 8px;
    overflow: hidden;
    margin: 10px 0;
  }
  
  .progress-bar {
    height: 100%;
    border-radius: 8px;
    transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1);
  }
  
  /* Button dengan gradient */
  .btn-primary {
    background: linear-gradient(135deg, var(--accent), #059669);
    color: #fff;
    border: none;
    font-weight: 600;
  }
  
  .btn-primary:hover {
    background: linear-gradient(135deg, #059669, var(--accent));
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(16,185,129,0.4);
  }

  /* Animasi entrance untuk elemen */
  @keyframes fadeInUp {
    from {
      opacity: 0;
      transform: translateY(20px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }
  
  .animate-in {
    animation: fadeInUp 0.4s ease forwards;
  }

  /* Loading skeleton */
  .skeleton {
    background: linear-gradient(90deg, rgba(255,255,255,0.05) 25%, rgba(255,255,255,0.1) 50%, rgba(255,255,255,0.05) 75%);
    background-size: 200% 100%;
    animation: skeleton-loading 1.5s infinite;
    border-radius: 8px;
  }
  
  @keyframes skeleton-loading {
    0% { background-position: 200% 0; }
    100% { background-position: -200% 0; }
  }
</style>
</head>
<body>

<div class="app">
  <div class="camera-wrap">
    <video id="video" autoplay playsinline></video>
    <canvas id="canvas"></canvas>
    
    <div class="map-pin">üìç</div>
    
    <div class="header">PT Energi Batubara Lestari</div>


    <div class="topbar">
      <div class="chip" id="chipGPS" title="Akurasi GPS terakhir">
        <span class="dot"></span>
        <span id="chipGPSText">GPS: -</span>
      </div>
      <div class="chip" id="chipGoal" title="Target harian">
        <div id="chipGoalText">Target 100 ‚Ä¢ 0 selesai</div>
        <div class="goal-bar"><i id="goalBarFill"></i></div>
      </div>
    </div>

    <div class="overlay" id="overlayInfo">
      <h4>Data Tanaman</h4>
      <div class="row"><span class="label">Lokatik:</span> <span id="ovLokasi" class="value">-</span></div>
      <div class="row"><span class="label">Tinggi:</span> <span id="ovTinggi" class="value">10</span> cm</div>
      <div class="row"><span class="label">Jenis:</span> <span id="ovJenis" class="value">Akasia</span></div>
      <div class="row"><span class="label">Kesehatan:</span> <span id="ovHealth" class="value">-</span></div>
      <div class="row"><span class="label">Foto Lokal:</span> <span id="ovCount" class="value">0</span></div>
    </div>

    <div class="height-wrap">
      <div class="height-panel">
        <div style="display:flex;align-items:center;justify-content:space-between;gap:10px">
          <div><b>Tingih Tanaman</b> <span class="muted">(cm)</span></div>
          <div class="value" id="tinggiValueDisplay">10</div>
        </div>
        <input type="range" id="tinggiRange" min="10" max="300" step="1" value="10" aria-label="Tinggi (cm)" title="Geser untuk mengubah tinggi (10‚Äì300 cm)">
      </div>
    </div>

    <div class="quick" id="quickContainer">
      <div class="tag on" data-value="Akasia">Akasia</div>
      <div class="tag" data-value="Sengon">Sengon</div>
      <div class="tag" data-value="Nangka">Nangka</div>
      <div class="tag" data-value="Mahoni">Mahoni</div>
      <div class="tag" data-value="Nangka">Nangka</div>
    </div>

    <div class="toolbar">
      <button class="btn round" id="btnLastPhoto" title="Foto Terakhir">
        <img id="lastPhotoThumb" src="" alt="Thumbnail foto terakhir">
      </button>
      <button class="btn round" id="btnGallery" title="Buka Galeri & Analitik">‚ò∞</button>
      <button class="btn round" id="btnSettings" title="Ambil Ulang GPS Presisi">üìç</button>
      <div class="fab" id="btnCapture" title="Ambil Foto"></div>
      <button class="btn round" id="btnFlipCamera" title="Balik Kamera">üîÑ</button>
      <a href="https://www.montana-tech.info/" class="btn round" title="Kembali ke Menu Utama">‚Üê</a>
    </div>
  </div>

  <div class="sheet" id="sheet">
    <div class="handle" id="handle"><div class="bar"></div></div>
    <div class="sheet-content">
      <div class="grid-2">
        <div class="card">
          <h3>Data Monitoring</h3>
          <div class="row-flex">
            <div>
              <label>Tinggi (cm)</label>
              <input id="tinggi" type="number" min="10" max="300" step="1" value="10" placeholder="cth: 120">
            </div>
            <div>
              <label>Jenis Tanaman</label>
              <input id="jenis" type="text" placeholder="Akasia/Sengon/...">
            </div>
          </div>
          <div class="row-flex" style="margin-top:10px">
            <div>
              <label>Tahun Tanam</label>
              <input id="tahun" type="number" min="2023" max="2027" placeholder="202X">
            </div>
            <div>
              <label>Lokasi (lat,lon)</label>
              <input id="lokasi" type="text" placeholder="-2.12345, 113.12345">
            </div>
          </div>
          <div class="row-flex" style="margin-top:10px">
            <div>
              <label>Pengawas</label>
              <input id="pengawas" type="text" placeholder="Nama pengawas">
            </div>
            <div>
              <label>Vendor</label>
              <input id="vendor" type="text" placeholder="Nama vendor">
            </div>
          </div>
          <div class="row-flex" style="margin-top:10px">
            <div>
              <label>Kesehatan</label>
              <input id="kesehatan" type="text" placeholder="Sehat/Merana/Mati">
            </div>
            <div>
              <label>Apps Script URL</label>
              <input id="appsScriptUrl" type="text" value="https://script.google.com/macros/s/AKfycbxG9ljYO7izzI2J7ifkloN01Kgkg1F-nZhVfRfBVQmXlGRqUhWIVxqYMljy354o1Cgo9A/exec" placeholder="https://script.google.com/macros/s/xxx/exec">
            </div>
          </div>
          <div style="display:flex;gap:10px;align-items:center;margin-top:12px">
            <button class="btn" id="btnUpload">Sync Pending</button>
            <button class="btn" id="btnExportCSV">Export CSV</button>
            <button class="btn" id="btnExportZIP">Export ZIP</button>
          </div>
          <div class="hr"></div>
          <div class="muted" id="status">Status: siap</div>
        </div>

        <div class="card">
          <h3>Peta Interaktif (Leaflet)</h3>
          <div id="map"></div>
        </div>
      </div>

      <div class="grid-2">
        <div class="card">
          <h3>Scatter: Tinggi vs Tahun</h3>
          <canvas id="chartScatter" height="220"></canvas>
        </div>
        <div class="card">
          <h3>Distribusi Tinggi (Histogram)</h3>
          <canvas id="chartHist" height="220"></canvas>
        </div>
      </div>

      <div class="card">
        <h3>Health Index (HSV)</h3>
        <canvas id="chartHealth" height="220"></canvas>
      </div>

      <div class="card">
        <h3>Analisis Ekologi Cerdas</h3>
        <div id="ccResult" class="muted">Memuat...</div>
      </div>

      <div class="card">
        <h3>Preview 8 Foto Terakhir</h3>
        <div id="reviewFoto" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(90px,1fr));gap:8px"></div>
      </div>

      <div class="card">
        <h3>Unduhan Cepat</h3>
        <div class="download-links">
          <a href="#" id="dlCSV">Download CSV</a>
          <a href="#" id="dlZIP">Download ZIP (semua foto)</a>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="toast" id="toast">
  <div id="toastMsg">Siap.</div>
  <div class="progress"><i id="toastProg"></i></div>
</div>

<script>
// ============ State ============

const db = new Dexie("monitoringDB");
db.version(2).stores({
  monitoring: '++idx, id, tanggal, lokasi, tinggi, *koordinat, jenis, tahun, pengawas, vendor, kesehatan, akurasi, n, foto, statusUpload'
});


let lastGPS = { koordinat: "", akurasi: 999, n: 0 };
let goalTarget = 100;
let map, markersLayer;
let scatterChart, histChart, healthChart;
let currentStream = null;
let currentDeviceId = null;
let captureCountForZip = 0;
let isWatchingGPS = false;
let videoDevices = [];

// ============ DOM ============
const video = document.getElementById('video');
const canvas = document.getElementById('canvas');
const btnCapture = document.getElementById('btnCapture');

// G7: DOM Toolbar Baru
const btnGallery = document.getElementById('btnGallery');
const btnFlipCamera = document.getElementById('btnFlipCamera');
const btnSettings = document.getElementById('btnSettings');
const lastPhotoThumb = document.getElementById('lastPhotoThumb');

const sheet = document.getElementById('sheet');
const handle = document.getElementById('handle');
const tinggiRange = document.getElementById('tinggiRange');
const tinggiInput = document.getElementById('tinggi');
const tinggiValueDisplay = document.getElementById('tinggiValueDisplay');
const ovLokasi = document.getElementById('ovLokasi');
const ovTinggi = document.getElementById('ovTinggi');
const ovJenis = document.getElementById('ovJenis');
const ovHealth = document.getElementById('ovHealth');
const ovCount = document.getElementById('ovCount');
const chipGPS = document.getElementById('chipGPS');
const chipGPSText = document.getElementById('chipGPSText');

// G2: DOM Target Progress Bar
const chipGoalText = document.getElementById('chipGoalText');
const goalBarFill = document.getElementById('goalBarFill');

const jenisInput = document.getElementById('jenis');
const tahunInput = document.getElementById('tahun');
const lokasiInput = document.getElementById('lokasi');
const pengawasInput = document.getElementById('pengawas');
const vendorInput = document.getElementById('vendor');
const kesehatanInput = document.getElementById('kesehatan');
const statusText = document.getElementById('status');
const appsScriptUrlInput = document.getElementById('appsScriptUrl');
const toast = document.getElementById('toast');
const toastMsg = document.getElementById('toastMsg');
const toastProg = document.getElementById('toastProg');
const overlayInfo = document.getElementById('overlayInfo');
const reviewFoto = document.getElementById('reviewFoto');
const ccResultEl = document.getElementById('ccResult');

let brand = "PT ENERGI BATUBARA LESTARI";

// ============ Utils ============
const pad = (n)=> n.toString().padStart(2,'0');
const genId = ()=>{
  const d=new Date();
  return d.getFullYear()+""+pad(d.getMonth()+1)+pad(d.getDate())+"-"+pad(d.getHours())+pad(d.getMinutes())+pad(d.getSeconds());
};
function showToast(msg, progress=0){
  toastMsg.textContent = msg;
  toast.classList.add('show');
  toastProg.style.width = (progress*100)+'%';
  clearTimeout(window.__toastTO);
  window.__toastTO = setTimeout(()=> toast.classList.remove('show'), 1800);
}
function safeFilename(s){ return String(s||'').replace(/[^\w.-]/g,"_"); }
function dataURLtoBlob(dataurl){
  const arr = dataurl.split(',');
  const mime = (arr[0].match(/:(.*?);/)||[])[1]||'image/jpeg';
  const bstr = atob(arr[1]); let n=bstr.length; const u8=new Uint8Array(n);
  while(n--){ u8[n]=bstr.charCodeAt(n); }
  return new Blob([u8], {type:mime});
}
function blobToDataURL(blob) {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onloadend = () => resolve(reader.result);
    reader.onerror = reject;
    reader.readAsDataURL(blob);
  });
}
function parseLatLon(str){
  const p=(str||"").split(',').map(s=>s.trim());
  if(p.length<2) return null;
  const lat=parseFloat(p[0]); const lon=parseFloat(p[1]);
  if(isNaN(lat)||isNaN(lon)) return null;
  return {lat,lon};
}
function toDMS(coord){
  const abs=Math.abs(coord);
  const deg=Math.floor(abs);
  const min=Math.floor((abs-deg)*60);
  const sec=(abs-deg-min/60)*3600;
  return [[deg,1],[min,1],[Math.round(sec*100),100]];
}

function haversine(lat1, lon1, lat2, lon2) {
    const R = 6371e3; // meter
    const œÜ1 = lat1 * Math.PI/180;
    const œÜ2 = lat2 * Math.PI/180;
    const ŒîœÜ = (lat2-lat1) * Math.PI/180;
    const ŒîŒª = (lon2-lon1) * Math.PI/180;

    const a = Math.sin(ŒîœÜ/2) * Math.sin(ŒîœÜ/2) +
              Math.cos(œÜ1) * Math.cos(œÜ2) *
              Math.sin(ŒîŒª/2) * Math.sin(ŒîŒª/2);
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    return R * c; // meter
}

// ============ Camera ============
async function listCameras(){
  if(!navigator.mediaDevices?.enumerateDevices) return;
  try {
    const devices = await navigator.mediaDevices.enumerateDevices();
    videoDevices = devices.filter(d=>d.kind==="videoinput");
    
    // Prioritaskan kamera belakang
    const back = videoDevices.find(v=>/back|rear|environment/i.test(v.label)) || videoDevices[0];
    if(back) startCamera(back.deviceId);
    else showToast("Tidak ditemukan kamera.", 0);
  } catch(e) {
    showToast("Gagal enumerasi kamera: " + (e.message||e), 0);
  }
}
async function startCamera(deviceId){
  if(currentStream){ currentStream.getTracks().forEach(t=>t.stop()); }
  const constraints = { video: { deviceId: deviceId? { exact: deviceId } : undefined, facingMode:'environment' } };
  try{
    const s = await navigator.mediaDevices.getUserMedia(constraints);
    currentStream = s; 
    // Dapatkan deviceId aktual yang digunakan
    const videoTrack = s.getVideoTracks()[0];
    const settings = videoTrack.getSettings();
    currentDeviceId = settings.deviceId; 
    
    video.srcObject = s;
  }catch(e){
    showToast("Gagal akses kamera: "+(e.message||e),0);
  }
}
function flipCamera() {
  if (videoDevices.length < 2) {
    showToast("Hanya 1 kamera ditemukan", 0);
    return;
  }
  
  // Cari index kamera saat ini
  const currentIdx = videoDevices.findIndex(d => d.deviceId === currentDeviceId);
  // Putar ke kamera berikutnya
  const nextIdx = (currentIdx + 1) % videoDevices.length;
  
  startCamera(videoDevices[nextIdx].deviceId);
}

// ============ GPS ============
function updateGPSUI(text, accuracy) {
  if (accuracy <= 10) {
    chipGPSText.textContent = 'GPS: Aktif';
  } else if (accuracy < 999) {
    chipGPSText.textContent = `GPS: ¬±${accuracy.toFixed(0)}m`;
  } else {
    chipGPSText.textContent = text;
  }
  
  chipGPS.classList.remove('gps-good', 'gps-medium', 'gps-bad');
  if (accuracy <= 5) {
    chipGPS.classList.add('gps-good');
  } else if (accuracy <= 10) {
    chipGPS.classList.add('gps-medium');
  } else {
    chipGPS.classList.add('gps-bad');
  }
}

function getPreciseGPS() {
  return new Promise((resolve, reject) => {
    if (!navigator.geolocation) {
      reject(new Error('Geolocation tidak didukung'));
      return;
    }
    if (isWatchingGPS) {
      reject(new Error('GPS sudah aktif mencari'));
      return;
    }

    isWatchingGPS = true;
    btnSettings.classList.add('gps-sampling');
    btnSettings.disabled = true;

    let samples = [];
    const MAX_SAMPLES = 18;
    const MIN_SAMPLES = 5;
    const TARGET_ACCURACY = 5; // 5 meter
    const TIMEOUT = 15000; // 15 detik

    let watchId = null;

    const timeoutHandle = setTimeout(() => {
      stopWatch(new Error(`Timeout 15 detik. Menggunakan ${samples.length} sampel.`));
    }, TIMEOUT);

    const stopWatch = (error = null) => {
      if (!isWatchingGPS) return;
      
      navigator.geolocation.clearWatch(watchId);
      clearTimeout(timeoutHandle);
      isWatchingGPS = false;
      btnSettings.classList.remove('gps-sampling');
      btnSettings.disabled = false;
      btnSettings.innerHTML = 'üìç';

      if (samples.length === 0) {
        if (error) reject(error);
        else reject(new Error('Gagal mendapatkan sampel GPS.'));
        return;
      }

      let totalWeight = 0;
      let weightedLat = 0;
      let weightedLon = 0;
      let bestAccuracy = 999;

      for (const s of samples) {
        const w = 1.0 / (s.accuracy * s.accuracy); 
        weightedLat += s.latitude * w;
        weightedLon += s.longitude * w;
        totalWeight += w;
        if (s.accuracy < bestAccuracy) bestAccuracy = s.accuracy;
      }

      const finalLat = weightedLat / totalWeight;
      const finalLon = weightedLon / totalWeight;
      const finalAccuracy = bestAccuracy; 

      const result = {
        lat: finalLat,
        lon: finalLon,
        acc: +finalAccuracy.toFixed(1),
        n: samples.length
      };

      if (error) {
        showToast(error.message, 0.5);
        resolve(result);
      } else {
        resolve(result);
      }
    };

    watchId = navigator.geolocation.watchPosition(
      (pos) => {
        const { latitude, longitude, accuracy } = pos.coords;
        if (!accuracy || accuracy < 1) return;

        samples.push({ latitude, longitude, accuracy });

        btnSettings.innerHTML = `üì° ${samples.length}`;
        updateGPSUI(`GPS: ¬±${accuracy.toFixed(1)}m`, accuracy);
        
        if (accuracy <= TARGET_ACCURACY && samples.length >= MIN_SAMPLES) {
          stopWatch();
        } else if (samples.length >= MAX_SAMPLES) {
          stopWatch();
        }
      },
      (err) => {
        stopWatch(new Error(`GPS Error: ${err.message}`));
      },
      { enableHighAccuracy: true, maximumAge: 0 }
    );
  });
}

async function handleGPSButton() {
  if (isWatchingGPS) return;

  btnSettings.innerHTML = 'üì°';
  btnSettings.disabled = true;
  updateGPSUI('GPS: Mencari...', 999);

  try {
    const gpsResult = await getPreciseGPS();
    
    const { lat, lon, acc, n } = gpsResult;
    lastGPS = { koordinat: `${lat.toFixed(6)},${lon.toFixed(6)}`, akurasi: acc, n: n };
    
    lokasiInput.value = lastGPS.koordinat;
    ovLokasi.textContent = lastGPS.koordinat;
    
    const gpsText = `GPS: ¬±${acc}m (n=${n})`;
    updateGPSUI(gpsText, acc);
    showToast(`GPS presisi diperoleh ${gpsText}`, 1);

    addMapMarker(lat, lon, `Posisi saat ini (${gpsText})`);

  } catch (err) {
    console.error(err);
    const errorMsg = `GPS Gagal: ${err.message}`;
    showToast(errorMsg, 0);
    updateGPSUI('GPS: Gagal', 999);
    btnSettings.innerHTML = 'üìç';
    btnSettings.disabled = false;
  }
}

function startAutoGPSWatcher() {
  if (!navigator.geolocation) return;

  navigator.geolocation.watchPosition(
    (pos) => {
      const { latitude, longitude, accuracy } = pos.coords;

      // Abaikan sinyal buruk
      if (!accuracy || accuracy > 50) return;

      // Simpan koordinat otomatis
      lastGPS = {
        koordinat: `${latitude.toFixed(6)},${longitude.toFixed(6)}`,
        akurasi: accuracy.toFixed(1),
        n: 1
      };

      // Update UI
      lokasiInput.value = lastGPS.koordinat;
      ovLokasi.textContent = lastGPS.koordinat;
      updateGPSUI(`GPS: ¬±${accuracy.toFixed(0)}m`, accuracy);
    },
    (err) => {
      console.warn("Auto GPS error:", err);
      updateGPSUI("GPS: Gagal", 999);
    },
    { enableHighAccuracy: true, maximumAge: 0, timeout: 15000 }
  );
}


// ============ Slider sync ============
function syncFromRange(){
  const v = parseInt(tinggiRange.value,10);
  tinggiInput.value = v;
  tinggiValueDisplay.textContent = v;
  ovTinggi.textContent = v;
}
function syncFromInput(){
  let v = parseInt(tinggiInput.value,10);
  if(isNaN(v)) v = 10;
  v = Math.max(10, Math.min(300, v));
  tinggiInput.value = v;
  tinggiRange.value = v;
  tinggiValueDisplay.textContent = v;
  ovTinggi.textContent = v;
}
tinggiRange.addEventListener('input', syncFromRange);
tinggiInput.addEventListener('change', syncFromInput);
syncFromInput();

// ============ Quick multi-select jenis ============
(function initQuick(){
  const c = document.getElementById('quickContainer');
  c.querySelectorAll('.tag').forEach(tag=>{
    tag.addEventListener('click', ()=>{
      tag.classList.toggle('on');
      const sel = [...c.querySelectorAll('.tag.on')].map(t=>t.dataset.value);
      jenisInput.value = sel.join(', ');
      ovJenis.textContent = jenisInput.value || '-';
    });
  });
  // Set default dari tag 'on'
  jenisInput.value = "Akasia";
  ovJenis.textContent = "Akasia";
})();

// ============ Bottom sheet toggle ============
function toggleSheet(){ sheet.classList.toggle('visible'); }

// ============ Map ============
function initMap(){
  map = L.map('map').setView([0,110], 5);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {maxZoom:19, attribution:"¬© OpenStreetMap"}).addTo(map);
  markersLayer = L.layerGroup().addTo(map);
  refreshMarkers();
}
function addMapMarker(lat,lon, label, color="#22c55e"){
  if(!markersLayer) return;
  const m = L.circleMarker([lat,lon],{ radius:8, color:color, fillColor:color, fillOpacity:.8 });
  m.addTo(markersLayer).bindPopup(label||"");
}
async function refreshMarkers(){
  if(!markersLayer) return;
  markersLayer.clearLayers();
  
  await db.monitoring.each(d => {
    const p = parseLatLon(d.koordinat);
    if(!p) return;
    const color = d.kesehatan==="Sehat" ? "#22c55e" : (d.kesehatan==="Merana" ? "#f59e0b" : "#ef4444");
    
    const fotoUrl = URL.createObjectURL(d.foto);
    
    const html = `<b>${d.jenis||'-'}</b><br>ID: ${d.id}<br>Tinggi: ${d.tinggi}cm<br>Lok: ${d.lokasi}<br><img src="${fotoUrl}" style="width:140px;margin-top:6px;border-radius:6px"/>`;
    
    addMapMarker(p.lat,p.lon, html, color);
  });
}

// ============ Charts ============
function initCharts() {
  const ctxS = document.getElementById('chartScatter');
  const ctxH = document.getElementById('chartHist');
  const ctxHe = document.getElementById('chartHealth');

  scatterChart = new Chart(ctxS, {
    type: 'scatter',
    data: {
      datasets: [{
        label: 'Tinggi vs Tahun Tanam',
        data: [],
        pointRadius: 6,
        borderWidth: 1,
        borderColor: '#ffffff',
        backgroundColor: function(context) {
          const d = context.raw || {};
          if (d.kesehatan === 'Sehat') return '#22c55e';
          if (d.kesehatan === 'Merana') return '#f59e0b';
          if (d.kesehatan === 'Mati') return '#ef4444';
          return '#3b82f6';
        }
      }]
    },
    options: {
      scales: {
        x: { 
          type: 'linear', 
          position: 'bottom', 
          title: { display: true, text: 'Tahun Tanam' },
          min: 2023, 
          max: 2027,
          ticks: {
            stepSize: 1,
            format: {
              maximumFractionDigits: 0
            }
          }
        },
        y: { title: { display: true, text: 'Tinggi (cm)' } }
      }
    }
  });

  histChart = new Chart(ctxH, {
    type: 'bar',
    data: {
      labels: [],
      datasets: [{
        label: 'Jumlah Tanaman',
        data: [],
        backgroundColor: '#3b82f6'
      }]
    },
    options: {
      scales: {
        x: { title: { display: true, text: 'Rentang Tinggi (cm)' } },
        y: { beginAtZero: true, title: { display: true, text: 'Jumlah' } }
      }
    }
  });

  healthChart = new Chart(ctxHe, {
    type: 'bar',
    data: {
      labels: ['Sehat', 'Merana', 'Mati'],
      datasets: [{
        label: 'Jumlah Tanaman',
        data: [0, 0, 0],
        backgroundColor: ['#22c55e', '#f59e0b', '#ef4444']
      }]
    },
    options: {
      scales: {
        y: { beginAtZero: true, title: { display: true, text: 'Jumlah' } }
      }
    }
  });

  refreshCharts();
}
async function refreshCharts() {
  const allData = await db.monitoring.toArray();

  // Scatter Chart
  const pts = allData
    .filter(d => d.tahun && d.tinggi)
    .map(d => ({
      x: +d.tahun,
      y: +d.tinggi,
      kesehatan: d.kesehatan
    }));

  if (scatterChart) {
    scatterChart.data.datasets[0].data = pts;
    scatterChart.update();
  }

  // Histogram Chart
  const heights = allData.map(d => +d.tinggi).filter(Boolean);
  const bins = [0, 50, 100, 150, 200, 250, 300];
  const counts = new Array(bins.length - 1).fill(0);
  heights.forEach(h => {
    for (let i = 0; i < bins.length - 1; i++) {
      if (h > bins[i] && h <= bins[i + 1]) {
        counts[i]++;
        break;
      }
    }
  });
  const labels = bins.slice(0, -1).map((b, i) => `${bins[i] + 1}-${bins[i + 1]}`);
  if (histChart) {
    histChart.data.labels = labels;
    histChart.data.datasets[0].data = counts;
    histChart.update();
  }

  // Health Chart
  const healthCounts = { Sehat: 0, Merana: 0, Mati: 0 };
  allData.forEach(d => {
    if (healthCounts[d.kesehatan] !== undefined) healthCounts[d.kesehatan]++;
  });
  if (healthChart) {
    healthChart.data.datasets[0].data = [
      healthCounts.Sehat,
      healthCounts.Merana,
      healthCounts.Mati
    ];
    healthChart.update();
  }
}

// ============ AI HSV (simple) ============
function analyzeHSV(imgData){
  const {data:arr,width,height} = imgData;
  let r=0,g=0,b=0,c=0;
  for(let y=0;y<height;y+=4){
    for(let x=0;x<width;x+=4){
      const i=(y*width+x)*4;
      r+=arr[i]; g+=arr[i+1]; b+=arr[i+2]; c++;
    }
  }
  r=Math.round(r/c); g=Math.round(g/c); b=Math.round(b/c);
  const mx=Math.max(r,g,b)/255, diff=mx-Math.min(r,g,b)/255;
  let h=0; let s = mx===0?0:diff/mx; let v=mx;
  if(diff!=0){
    const rr=r/255, gg=g/255, bb=b/255;
    if(mx===rr){ h=60*(((gg-bb)/diff)%6); }
    else if(mx===gg){ h=60*(((bb-rr)/diff)+2); }
    else { h=60*(((rr-gg)/diff)+4); }
  }
  if(h<0) h+=360;
  let label="Sehat";
  if(v<0.25 || (h>0 && h<25)) label="Mati (Level 1)";
  else if((h>=25 && h<=65) && v>0.25) label="Merana (Level 2)";
  else label = "Baik (Level 4)";
  return {h:Math.round(h), s:+s.toFixed(2), v:+v.toFixed(2), label};
}

// ============ EXIF Writer ============
function insertExif(dataUrl, meta){
  if(typeof piexif === 'undefined'){ console.warn('piexif not loaded'); return dataUrl; }
  try{
    const ts = meta.timestamp;
    const exifTime = ts.getFullYear()+":"+pad(ts.getMonth()+1)+":"+pad(ts.getDate())+" "+pad(ts.getHours())+":"+pad(ts.getMinutes())+":"+pad(ts.getSeconds());
    const gps = {};
    const ll = parseLatLon(meta.koordinat||"");
    if(ll){
      gps[piexif.GPSIFD.GPSLatitudeRef] = ll.lat<0? "S":"N";
      gps[piexif.GPSIFD.GPSLatitude] = toDMS(ll.lat);
      gps[piexif.GPSIFD.GPSLongitudeRef] = ll.lon<0? "W":"E";
      gps[piexif.GPSIFD.GPSLongitude] = toDMS(ll.lon);
      gps[piexif.GPSIFD.GPSMapDatum] = "WGS-84";
      if(meta.akurasi){
        const dop = Math.max(0, Math.min(10000, Math.round(parseFloat(meta.akurasi)*100)));
        gps[piexif.GPSIFD.GPSDOP] = [dop,100];
      }
    }
    const comment = `ID:${meta.id}; Tinggi:${meta.tinggi}cm; Jenis:${meta.jenis}; Lokasi:${meta.koordinat}; Pengawas:${meta.pengawas||''}`;
    const exifObj = {
      "0th": {
        [piexif.ImageIFD.Make]: brand,
        [piexif.ImageIFD.Model]: "Web Camera",
        [piexif.ImageIFD.Software]: "v10_Mockup",
        [piexif.ImageIFD.DateTime]: exifTime,
        [piexif.ImageIFD.Orientation]: 1
      },
      "Exif": {
        [piexif.ExifIFD.DateTimeOriginal]: exifTime,
        [piexif.ExifIFD.DateTimeDigitized]: exifTime,
        [piexif.ExifIFD.UserComment]: piexif.helper.encodeText(comment)
      },
      "GPS": gps
    };
    const exifStr = piexif.dump(exifObj);
    return piexif.insert(exifStr, dataUrl);
  }catch(e){
    console.warn("EXIF insert failed:", e);
    return dataUrl;
  }
}

// ============ Capture Flow ============
async function capture(){
  if(!video.videoWidth){ showToast("Video belum siap",0); return; }
  
  let tahun = parseInt(tahunInput.value, 10);
  const tahunSekarang = new Date().getFullYear();
  const minTahun = 2023;
  const maxTahun = 2027;

  if (isNaN(tahun)) {
      tahun = Math.max(minTahun, Math.min(maxTahun, tahunSekarang));
      showToast(`Tahun tanam diset ke tahun sekarang: ${tahun}`, 0.8);
  } else if (tahun < minTahun) {
      tahun = minTahun;
      showToast(`Tahun tanam diset ke minimum: ${tahun}`, 0.8);
  } else if (tahun > maxTahun) {
      tahun = maxTahun;
      showToast(`Tahun tanam diset ke maksimum: ${tahun}`, 0.8);
  }
  tahunInput.value = tahun;

  if (lastGPS.akurasi > 10) {
    showToast(`Akurasi kurang bagus (${lastGPS.akurasi}m). Tetap disimpan.`, 0.5);
  }

  const id = genId();
  const tinggi = parseInt(tinggiInput.value||tinggiRange.value,10) || 10;
  if(tinggi<=0){ showToast("Tinggi tidak valid",0); return; }

  canvas.width = video.videoWidth;
  canvas.height = video.videoHeight;
  const ctx = canvas.getContext('2d');
  ctx.drawImage(video,0,0,canvas.width,canvas.height);

  const sample = ctx.getImageData(0,0,canvas.width,canvas.height);
  const hsv = analyzeHSV(sample);
  kesehatanInput.value = kesehatanInput.value || hsv.label;
  ovHealth.textContent = hsv.label;

  const margin=20, lh=Math.max(18, Math.round(canvas.height*0.022));
  ctx.font = `bold ${lh}px sans-serif`;
  ctx.fillStyle = 'rgba(255,255,255,.96)';
  ctx.strokeStyle = 'rgba(0,0,0,.75)';
  ctx.lineWidth = Math.max(3, Math.round(lh*0.15));
  const tanggal = new Date().toLocaleString('id-ID');
  const lines = [
    `Lokasi: ${lokasiInput.value||lastGPS.koordinat||'-'}`,
    `Tinggi: ${tinggi} cm`,
    `Jenis: ${jenisInput.value||'-'}`,
    `Koordinat: ${lastGPS.koordinat||'-'}`,
    `Akurasi: ¬±${lastGPS.akurasi||'-'} m (n=${lastGPS.n})`,
    `Tanggal: ${tanggal}`
  ];
  lines.forEach((t,i)=>{
    const y = canvas.height - margin - (lines.length-1-i)*(lh+8);
    ctx.strokeText(t, margin, y);
    ctx.fillText(t, margin, y);
  });
  const w = ctx.measureText(brand).width;
  ctx.strokeText(brand, canvas.width - margin - w, margin+lh);
  ctx.fillText(brand, canvas.width - margin - w, margin+lh);

  let dataUrl = canvas.toDataURL('image/jpeg', 0.9);
  
  // G7: Buat thumbnail kecil untuk tombol
  const thumbUrl = canvas.toDataURL('image/jpeg', 0.1);
  lastPhotoThumb.src = thumbUrl;

  dataUrl = insertExif(dataUrl, {
    id, tinggi, jenis: jenisInput.value, koordinat: lastGPS.koordinat, akurasi: lastGPS.akurasi, pengawas: pengawasInput.value, timestamp: new Date()
  });

  const fotoBlob = dataURLtoBlob(dataUrl);

  try{
    const a = document.createElement('a');
    a.href = URL.createObjectURL(fotoBlob);
    a.download = `foto_${safeFilename(id)}.jpg`;
    document.body.appendChild(a);
    a.click();
    a.remove();
    setTimeout(()=>URL.revokeObjectURL(a.href), 1000);
  }catch(e){ console.warn("Auto download gagal:", e); }

  const entry = {
    id,
    tanggal,
    lokasi: lokasiInput.value||lastGPS.koordinat||"",
    pekerjaan: "",
    tahun: tahun,
    jenis: jenisInput.value||"",
    tim: "",
    tinggi,
    kesehatan: kesehatanInput.value||hsv.label,
    koordinat: lastGPS.koordinat||"",
    akurasi: lastGPS.akurasi,
    n: lastGPS.n, 
    x: parseLatLon(lastGPS.koordinat||"")?.lon || "",
    y: parseLatLon(lastGPS.koordinat||"")?.lat || "",
    pengawas: pengawasInput.value||"",
    vendor: vendorInput.value||"",
    foto: fotoBlob,
    statusUpload: 'pending'
  };
  
  await db.monitoring.add(entry);
  
  await updateUICounters();
  
  await Promise.all([
    refreshMarkers(),
    refreshCharts(),
    renderReview(),
    updateCapacityAnalysis()
  ]);

  if(navigator.vibrate) navigator.vibrate(30);
  showToast("Foto tersimpan (offline)",1);

  const url = (appsScriptUrlInput.value||"").trim();
  if(url){
    try{
      const newEntryFromDB = await db.monitoring.where('id').equals(entry.id).first();
      await uploadEntry(newEntryFromDB, dataUrl, url);
    }catch(e){
      console.warn("Upload gagal:", e);
      showToast("Upload gagal (check Apps Script)",0);
    }
  }

  captureCountForZip++;
  if(captureCountForZip % 10 === 0){
    autoZipNow();
  }
}

async function updateUICounters() {
  const count = await db.monitoring.count();
  ovCount.textContent = count;
  
  // Update progress bar
  const pct = Math.min(100, (count / goalTarget) * 100);
  chipGoalText.textContent = `Target ${goalTarget} ‚Ä¢ ${count} selesai`;
  goalBarFill.style.width = pct + '%';
  if (pct >= 100) {
    goalBarFill.style.backgroundColor = 'var(--warn)';
  } else {
    goalBarFill.style.backgroundColor = 'var(--accent)';
  }
}

async function renderReview(){
  reviewFoto.innerHTML = '';
  
  const reviewData = await db.monitoring.orderBy('idx').reverse().limit(8).toArray();
  
  reviewData.forEach(d=>{
    const img=document.createElement('img');
    const url = URL.createObjectURL(d.foto);
    img.src = url;
    
    img.style.width='100%'; img.style.height='90px'; img.style.objectFit='cover'; img.style.borderRadius='8px';
    reviewFoto.appendChild(img);
  });
  
  if (reviewData.length > 0) {
     const lastImg = reviewFoto.querySelector('img');
     if (lastImg) {
       lastPhotoThumb.src = lastImg.src;
     }
  }
}

// ============ Upload (Apps Script) ============
async function uploadEntry(entry, fotoDataUrl, url) {
  if (!entry || !entry.idx) return;
  
  try {
    const payload = {
      ID: entry.id, Tanggal: entry.tanggal, Lokasi: entry.lokasi, Pekerjaan: entry.pekerjaan, Tinggi: entry.tinggi,
      Koordinat: entry.koordinat, X: entry.x, Y: entry.y, Tanaman: entry.jenis, "Tahun Tanam": entry.tahun,
      Pengawas: entry.pengawas, Vendor: entry.vendor, 
      Gambar: fotoDataUrl,
      Gambar_Nama_File: `Montana V2_Images/Gambar Montana (${entry.id}).jpg`, LINK:""
    };
    
    await fetch(url, { method:'POST', mode:'no-cors', body: JSON.stringify(payload)});
    
    await db.monitoring.update(entry.idx, { statusUpload: 'synced' });
    showToast(`Data ${entry.id} terkirim`,1);

  } catch (e) {
    showToast(`Upload ${entry.id} gagal: ${e.message||e}`,0);
  }
}
async function syncAllPending(){
  const url = (appsScriptUrlInput.value||"").trim();
  if(!url){ showToast("Apps Script URL kosong",0); return; }

  const pendingData = await db.monitoring.where('statusUpload').equals('pending').toArray();
  
  if(!pendingData.length){
    showToast("Semua data sudah sinkron üëç", 1);
    return;
  }
  
  showToast(`Sinkronisasi ${pendingData.length} data...`, 0.1);
  statusText.textContent = `Mengirim ${pendingData.length} data...`;

  let count = 0;
  for (const entry of pendingData) {
    count++;
    showToast(`Mengirim ${count} dari ${pendingData.length}...`, count / pendingData.length);
    
    const fotoDataUrl = await blobToDataURL(entry.foto);
    await uploadEntry(entry, fotoDataUrl, url);
  }
  
  showToast("Sinkronisasi selesai.", 1);
  statusText.textContent = "Status: Sinkronisasi selesai.";
}

// ============ Export CSV & ZIP ============
async function buildCSV(){
  let csv = "ID,Tanggal,Lokasi,Tinggi,Koordinat,X,Y,Jenis,Tahun,Pengawas,Vendor,Kesehatan,Akurasi,GPS_Sampel,StatusUpload\n"; 
  const allData = await db.monitoring.toArray();
  allData.forEach(d=>{
    csv += `"${d.id}","${d.tanggal}","${d.lokasi}",${d.tinggi},"${d.koordinat}",${d.x},${d.y},"${d.jenis}","${d.tahun}","${d.pengawas||''}","${d.vendor||''}","${d.kesehatan}","${d.akurasi}","${d.n || 1}","${d.statusUpload}"\n`;
  });
  return csv;
}
async function exportCSV(){
  const dataCount = await db.monitoring.count();
  if(!dataCount){ showToast("Tidak ada data",0); return; }
  const csv = await buildCSV();
  saveAs(new Blob([csv], {type:'text/csv;charset=utf-8;'}), 'monitoring.csv');
  showToast("CSV diunduh",1);
}
async function exportZIP(filename='monitoring_images.zip'){
  const dataCount = await db.monitoring.count();
  if(!dataCount){ showToast("Tidak ada data",0); return; }
  
  const zip = new JSZip();
  const csv = await buildCSV();
  const allData = await db.monitoring.toArray();
  allData.forEach((d,i)=>{
    if(d.foto){
      zip.file(`images/foto_${i+1}_${safeFilename(d.id)}.jpg`, d.foto);
    }
  });
  
  zip.file("data.csv", csv);
  const blob = await zip.generateAsync({type:'blob'});
  saveAs(blob, filename);
  showToast("ZIP diunduh",1);
}
async function autoZipNow(){
  const dataCount = await db.monitoring.count();
  await exportZIP(`monitoring_batch_${Math.ceil(dataCount/10)}.zip`);
}

// ============ FUNGSI ANALISIS EKOLOGI ============
async function analyzeEcology(areaHa = 1.0, idealDensity = 625, idealSpacing = 4, spacingTolerance = 0.25) {
  const all = await db.monitoring.toArray();
  const valid = all.filter(d => parseLatLon(d.koordinat) && d.kesehatan);

  if (valid.length === 0) {
    return { error: "Belum ada data untuk dianalisis." };
  }

  const sehat = valid.filter(d => d.kesehatan.startsWith("Baik"));
  const merana = valid.filter(d => d.kesehatan.startsWith("Merana"));
  const mati = valid.filter(d => d.kesehatan.startsWith("Mati"));

  const N_sehat = sehat.length;
  const N_merana = merana.length;
  const N_mati = mati.length;
  const N_total = valid.length;
  const R_sehat_pct = (N_sehat / N_total) * 100;
  let CC = (N_sehat / areaHa) * (R_sehat_pct / 100);
  let CCI_pct = (CC / idealDensity) * 100;
  CCI_pct = Math.max(0, Math.min(100, CCI_pct));
  const SAMPLE_MAX = 100;
  const sample = valid.slice();
  if (sample.length > SAMPLE_MAX) {
    for (let i = sample.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [sample[i], sample[j]] = [sample[j], sample[i]];
    }
    sample.length = SAMPLE_MAX;
  }
  const distArr = [];
  for (let i = 0; i < sample.length - 1; i++) {
    for (let j = i + 1; j < sample.length; j++) {
      const a = parseLatLon(sample[i].koordinat);
      const b = parseLatLon(sample[j].koordinat);
      if (!a || !b) continue;
      const d = haversine(a.lat, a.lon, b.lat, b.lon);
      if (d <= 0 || d > 20000) continue; 
      distArr.push(d);
    }
  }
  let meanDist = 0, sigma = 0, conformity_pct = 0;
  if (distArr.length > 0) {
    const sum = distArr.reduce((a, b) => a + b, 0);
    meanDist = sum / distArr.length;
    const variance = distArr.reduce((a, v) => a + Math.pow(v - meanDist, 2), 0) / distArr.length;
    sigma = Math.sqrt(variance);
    const minSpace = idealSpacing * (1 - spacingTolerance);
    const maxSpace = idealSpacing * (1 + spacingTolerance);
    const within = distArr.filter(d => d >= minSpace && d <= maxSpace);
    conformity_pct = (within.length / distArr.length) * 100;
  }
  const accs = valid.map(v => v.akurasi).filter(a => a && a < 100).sort((a, b) => a - b);
  const medianAcc = accs.length ? (accs.length % 2 === 0 ? (accs[accs.length/2-1] + accs[accs.length/2])/2 : accs[Math.floor(accs.length/2)]) : 0;
  const issues = [];
  if (medianAcc > 10) issues.push("Akurasi GPS rendah (>10m)");
  if (conformity_pct < 50) issues.push("Sebaran tanaman tidak seragam");
  if (R_sehat_pct < 60) issues.push("Banyak tanaman tidak sehat");
  if (CCI_pct < 40) issues.push("Kapasitas ekologi rendah");
  return {
    N_total, N_sehat, N_merana, N_mati,
    R_sehat_pct, CC, CCI_pct,
    meanDist, sigma, conformity_pct,
    medianAcc,
    issues,
    sampleSize: sample.length
  };
}
async function updateCapacityAnalysis() {
  if (!ccResultEl) return;
  ccResultEl.innerHTML = `<span class="muted">Menganalisis data...</span>`;
  try {
    const r = await analyzeEcology(1.0, 625, 4, 0.25);
    if (r.error) {
      ccResultEl.innerHTML = `<span class="muted">${r.error}</span>`;
      return;
    }
    let barColor = 'var(--danger)';
    let grade = 'Buruk';
    if (r.CCI_pct >= 80) { barColor = 'var(--accent)'; grade = 'Optimal'; }
    else if (r.CCI_pct >= 60) { barColor = 'var(--warn)'; grade = 'Baik'; }
    else if (r.CCI_pct >= 40) { barColor = '#3b82f6'; grade = 'Cukup'; }
    const issueHTML = r.issues && r.issues.length ? `<div class="row" style="color:var(--danger);">‚ö†Ô∏è ${r.issues.join('; ')}</div>` : `<div class="row" style="color:var(--accent);">‚úÖ Tidak ada anomali signifikan</div>`;
    ccResultEl.innerHTML = `
      <div class="row">üå± ${r.N_sehat} sehat ‚Ä¢ ‚ö†Ô∏è ${r.N_merana} merana ‚Ä¢ ‚ùå ${r.N_mati} mati</div>
      <div class="row">üíö Rasio Sehat: ${r.R_sehat_pct.toFixed(1)}%</div>
      <div class="progress-bar-container" title="Efisiensi: ${r.CCI_pct.toFixed(1)}%">
        <div class="progress-bar" style="width: ${r.CCI_pct.toFixed(1)}%; background-color: ${barColor};"></div>
      </div>
      <div class="row">üìà Kapasitas: <b>${r.CC.toFixed(0)}</b> pohon/ha</div>
      <div class="row">üî¢ Efisiensi: ${r.CCI_pct.toFixed(1)}% (${grade})</div>
      <div class="hr"></div>
      <div class="row">üìè Jarak (n=${r.sampleSize} sampel): ${r.meanDist.toFixed(1)} m (œÉ ${r.sigma.toFixed(1)})</div>
      <div class="row">‚úÖ Kesesuaian: ${r.conformity_pct.toFixed(1)}% (antara ${ (4*(1-0.25)).toFixed(1) } - ${ (4*(1+0.25)).toFixed(1) } m)</div>
      <div class="row">üì° Median Akurasi: ${r.medianAcc.toFixed(1)} m</div>
      ${issueHTML}
    `;
  } catch (e) {
    console.error("Gagal menganalisis ekologi:", e);
    ccResultEl.innerHTML = `<span class="muted" style="color: var(--danger);">Error: ${e.message}</span>`;
  }
}

// ===== Pengechea Kompatibilitas =====
function checkCompatibility() {
  let issues = [];
  
  if (!navigator.mediaDevices?.getUserMedia) {
    issues.push("Fitur kamera tidak didukung/diblokir.");
  }
  if (!navigator.geolocation) {
    issues.push("Fitur GPS tidak didukung/diblokir.");
  }
  
  if (typeof(Dexie) === 'undefined') {
    issues.push("Database Dexie gagal dimuat (perlu internet).");
  }
  if (typeof(L) === 'undefined') {
    issues.push("Peta Leaflet gagal dimuat (perlu internet).");
  }
  if (typeof(Chart) === 'undefined') {
    issues.push("Grafik Chart.js gagal dimuat (perlu internet).");
  }

  if (!window.isSecureContext) {
      if (location.protocol === 'file:') {
          issues.push("Aplikasi tidak bisa dibuka dari 'file:///'. Harap gunakan server lokal (localhost).");
      } 
      else if (location.protocol === 'http:' && location.hostname !== 'localhost' && location.hostname !== '127.0.0.1') {
          issues.push("Kamera & GPS memerlukan koneksi aman (HTTPS) atau 'localhost'. Membuka via 'http://' (selain localhost) tidak diizinkan.");
      }
  }

  if (issues.length > 0) {
    const errorMsg = "Peringatan Kompatibilitas:\n- " + issues.join("\n- ");
    console.error(errorMsg);
    
    alert(errorMsg + "\n\nMohon buka aplikasi ini melalui server HTTPS atau 'localhost' untuk menggunakan kamera dan GPS.");
    
    try {
      document.getElementById('btnCapture').disabled = true;
      document.getElementById('btnSettings').disabled = true;
      document.getElementById('btnCapture').title = "Kamera tidak bisa diakses (Konteks Tidak Aman)";
      document.getElementById('btnSettings').title = "GPS tidak bisa diakses (Konteks Tidak Aman)";
    } catch(e) {}
  }
}


// ============ Events ============
btnSettings.addEventListener('click', handleGPSButton);
btnGallery.addEventListener('click', toggleSheet);
btnFlipCamera.addEventListener('click', flipCamera);

btnCapture.addEventListener('click', capture);
document.addEventListener('keydown', (e)=>{ if(e.key==="Enter") capture(); });
document.getElementById('btnUpload').addEventListener('click', syncAllPending);
document.getElementById('btnExportCSV').addEventListener('click', exportCSV);
document.getElementById('btnExportZIP').addEventListener('click', ()=>exportZIP());
document.getElementById('dlCSV').addEventListener('click', (e)=>{e.preventDefault(); exportCSV();});
document.getElementById('dlZIP').addEventListener('click', (e)=>{e.preventDefault(); exportZIP();});
handle.addEventListener('click', toggleSheet);

// ============ Init ============
(async function init(){
  checkCompatibility();

  // Hidupkan GPS otomatis di belakang layar
  startAutoGPSWatcher();

  try{
    await listCameras();
    initMap();
    initCharts();
    await updateUICounters();
    
    await updateCapacityAnalysis();
    
    const savedUrl = localStorage.getItem('appsScriptUrl')||"";
    if(!savedUrl && appsScriptUrlInput.value){ localStorage.setItem('appsScriptUrl', appsScriptUrlInput.value); }
    else if(savedUrl){ appsScriptUrlInput.value = savedUrl; }
    appsScriptUrlInput.addEventListener('input', ()=> localStorage.setItem('appsScriptUrl', appsScriptUrlInput.value||""));
    
    await renderReview();
  }catch(e){
    console.error(e);
  }
})();
</script>
</body>
</html>
